name: Debug SSH Connection

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test basic connectivity
      run: |
        echo "ğŸ” Probando conectividad bÃ¡sica..."
        echo "Host: ${{ secrets.DEV_VPS_HOST }}"
        
        # Test ping
        echo "ğŸ“¡ Testing ping..."
        ping -c 3 ${{ secrets.DEV_VPS_HOST }} || echo "âŒ Ping failed"
        
        # Test port 22
        echo "ğŸšª Testing port 22..."
        timeout 10 bash -c "</dev/tcp/${{ secrets.DEV_VPS_HOST }}/22" && echo "âœ… Port 22 is open" || echo "âŒ Port 22 is closed/filtered"
        
        # Test with nc (netcat)
        echo "ğŸ”Œ Testing with netcat..."
        nc -zv ${{ secrets.DEV_VPS_HOST }} 22 || echo "âŒ Netcat connection failed"
        
        # Test SSH banner
        echo "ğŸ“‹ Getting SSH banner..."
        timeout 10 ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@${{ secrets.DEV_VPS_HOST }} "echo 'Connection successful'" || echo "âŒ SSH connection failed"
    
    - name: Test with sshpass (password auth)
      run: |
        echo "ğŸ” Testing password authentication..."
        
        # Install sshpass
        sudo apt-get update && sudo apt-get install -y sshpass
        
        # Test connection with password
        echo "ğŸ”‘ Testing sshpass connection..."
        sshpass -p "${{ secrets.DEV_VPS_PASSWORD }}" ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ secrets.DEV_VPS_HOST }} "echo 'Password auth successful'; whoami; pwd" || echo "âŒ Password authentication failed"
    
    - name: Test with appleboy action
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.DEV_VPS_HOST }}
        username: ubuntu
        password: ${{ secrets.DEV_VPS_PASSWORD }}
        timeout: 30s
        debug: true
        script: |
          echo "âœ… SSH connection successful with appleboy"
          whoami
          pwd
          uname -a